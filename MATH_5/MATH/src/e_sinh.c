#include "cdefs-compat.h"

/* __ieee754_sinh(x)
 * Method : 
 * mathematically sinh(x) if defined to be (exp(x)-exp(-x))/2
 *	1. Replace x by |x| (sinh(-x) = -sinh(x)). 
 *	2. 
 *		                                    E + E/(E+1)
 *	    0        <= x <= 22     :  sinh(x) := --------------, E=expm1(x)
 *			       			        2
 *
 *	    22       <= x <= lnovft :  sinh(x) := exp(x)/2 
 *	    lnovft   <= x <= ln2ovft:  sinh(x) := exp(x/2)/2 * exp(x/2)
 *	    ln2ovft  <  x	    :  sinh(x) := x*shuge (overflow)
 *
 * Special cases:
 *	sinh(x) is |x| if x is +INF, -INF, or NaN.
 *	only sinh(0)=0 is exact for finite x.
 */

#include <float.h>
#include <MATH_math.h>

#include "math_private.h"

static const double one = 1.0, shuge = 1.0e307;
/*
	e_sinh.cç”¨äºè®¡ç®—ä¸€ä¸ªæ•°xçš„åŒæ›²æ­£å¼¦å‡½æ•°å€¼ï¼Œå‡½æ•°é¦–å…ˆåˆ©ç”¨åŒæ›²æ­£å¼¦çš„å¥‡å‡½æ•°æ€§è´¨ï¼Œå°†è¾“å…¥çš„è´Ÿæ•°è½¬æ¢ä¸ºæ­£æ•°è¿›è¡Œè®¡ç®—ï¼Œæœ€ç»ˆå†æ ¹æ®è¾“å…¥çš„ç¬¦å·è°ƒæ•´ç»“æœçš„æ­£è´Ÿã€‚åŒæ›²æ­£å¼¦å‡½æ•°çš„å®šä¹‰åŸŸå’Œå€¼åŸŸæ˜¯æ•´ä¸ªå®æ•°é›†ã€‚åŒæ›²æ­£å¼¦å‡½æ•°çš„æ•°å­¦å®šä¹‰æ˜¯ï¼š
		sinh(x) = (e^x - e^-x) / 2
	åŒæ›²æ­£å¼¦å‡½æ•°æ˜¯å¥‡å‡½æ•°ï¼Œå³ sinh(-x) = -sinh(x)ã€‚åœ¨è®¡ç®—å‰ï¼Œå¯ä»¥å¤„ç†è¾“å…¥çš„ç¬¦å·ï¼Œå°†æ‰€æœ‰è®¡ç®—è½¬æ¢ä¸ºå¤„ç†æ­£æ•°å€¼ï¼Œç„¶ååœ¨ç»“æœä¸­åŠ ä¸Šç¬¦å·ã€‚è¯¥å‡½æ•°çš„å®ç°é‡‡ç”¨äº†å¤šç§ç­–ç•¥æ¥å¤„ç†ä¸åŒèŒƒå›´çš„è¾“å…¥å€¼ï¼š
	å¯¹äºè¾“å…¥ä¸ºæ— ç©·å¤§æˆ–NaNæ—¶ï¼Œå‡½æ•°åº”ç›´æ¥è¿”å›ç›¸åº”çš„æ— ç©·å¤§æˆ–NaNã€‚å³ï¼š
		sinh(Inf) = Inf
		sinh(-Inf) = -Inf
		sinh(NaN) = NaN
	è¾“å…¥èŒƒå›´ä¸º|x|<22æ—¶ï¼Œå½“|x|éå¸¸å°æ—¶ï¼Œsinh(x)â‰ˆxï¼Œå› ä¸ºåœ¨è¿™ç§æƒ…å†µä¸‹e^xâ‰ˆ1+xã€‚å¯¹äº|x|< 2^-28ï¼Œç›´æ¥è¿”å›xï¼Œå› ä¸ºè¯¥æƒ…å†µä¸‹sinh(x)ä¸xå‡ ä¹ç›¸ç­‰ã€‚å¯¹äºç¨å¤§ä½†ä»ç„¶è¾ƒå°çš„xï¼Œç›´æ¥ä½¿ç”¨å…¬å¼ sin(x)= (e^x - e^-x) / 2 è®¡ç®—e^x e^-xÂ å¯èƒ½å¸¦æ¥çš„ç²¾åº¦é—®é¢˜ï¼Œå› æ­¤å‡½æ•°é€šè¿‡è®¡ç®—e^xÂ âˆ’1æ¥é¿å…è¯¥é—®é¢˜ï¼Œå…·ä½“æ–¹æ³•æ˜¯ä»¤ ï¼Œå³å½“|ğ‘¥|<1Â æ—¶ï¼Œä½¿ç”¨ï¼š
		sinh(x) = (2t - (t^2 / (t + 1)) / 2)
	å¦åˆ™,å½“1<|x|<22æ—¶ï¼Œä½¿ç”¨ï¼š
		sinh(x) = (t + (t / (t + 1)) / 2)
	è¾“å…¥èŒƒå›´ä¸º22â‰¤|x|<log(maxdouble)æ—¶ï¼Œxè¾ƒå¤§ï¼Œsinh(x) â‰ˆ e^x / 2ï¼Œå› ä¸ºe^-xåœ¨æ•°å€¼ä¸Šå˜å¾—éå¸¸å°ï¼Œå¯ä»¥å¿½ç•¥ä¸è®¡ã€‚ä½¿ç”¨å…¬å¼ï¼š
		sinh = e ^ |x| / 2
	è¾“å…¥èŒƒå›´ä¸ºlog(maxdouble)â‰¤|x|â‰¤overflowthresoldæ—¶ï¼Œåœ¨è¿™ä¸ªèŒƒå›´å†…ï¼Œe^|x|å¯èƒ½éå¸¸å¤§ï¼Œç›´æ¥è®¡ç®—å®¹æ˜“å¯¼è‡´æº¢å‡ºã€‚å› æ­¤ï¼Œé‡‡ç”¨æ›´ç¨³å®šçš„æ•°å€¼æ–¹æ³•è®¡ç®—e^|x|ã€‚ä½¿ç”¨åˆ†æ®µè®¡ç®—å’Œè°ƒæ•´æŒ‡æ•°çš„æ–¹æ³•ï¼š
		sinh(x) = (e^x - e^-x) / 2 
	è¾“å…¥èŒƒå›´ä¸º|x|>overflowthresoldæ—¶ï¼Œåœ¨è¿™ä¸ªèŒƒå›´å†…ï¼Œxéå¸¸å¤§ï¼Œsinh(x)çš„ç»“æœä¼šéå¸¸å¤§ï¼Œæ¥è¿‘äºè®¡ç®—æœºèƒ½è¡¨ç¤ºçš„æœ€å¤§æ•°å€¼ã€‚è¿”å›ä¸€ä¸ªæå¤§çš„æ•°å€¼æ¥è¡¨ç¤ºæº¢å‡ºæƒ…å†µ,å³x*1.0e307ã€‚
*/
OLM_DLLEXPORT double
__ieee754_sinh(double x)
{
	double t,h;
	int32_t ix,jx,lx;

    /* High word of |x|. */
	EXTRACT_WORDS(jx, lx, x);
	ix = jx&0x7fffffff;

    /* 
		å½“Â xÂ ä¸ºæ— ç©·å¤§æ—¶ï¼Œsinh(x)Â åº”è¯¥è¿”å›ä¸€ä¸ªæ— ç©·å¤§çš„å€¼
	*/
	if(ix == 0x7ff00000 && lx == 0) return x;	
	/* 
		å½“è¾“å…¥ä¸­åŒ…å« NaN æ—¶ï¼Œæ ¹æ® IEEE 754 æ ‡å‡†ï¼Œä»»ä½•æ¶‰åŠ NaN çš„ç®—æœ¯è¿ç®—ç»“æœåº”ä¸º NaNã€‚æ­£ç¡®ä¼ æ’­ NaN è¾“å…¥ç¡®ä¿å‡½æ•°ç¬¦åˆ IEEE æµ®ç‚¹æ ‡å‡†ï¼Œå¹¶æä¾›å¯é¢„æµ‹çš„è¡Œä¸ºã€‚
	*/
	if(ix >= 0x7ff00000)
	{
		double result = x + x;
		int32_t high_word = 0x7FF40000;
		int32_t low_word = 0x00000000;
		SET_HIGH_WORD(result, high_word);
		SET_LOW_WORD(result, low_word);
		return result;
	}
	h = 0.5;
	if (jx<0) h = -h;
    /* |x| in [0,22], return sign(x)*0.5*(E+E/(E+1))) */
	if (ix < 0x40360000) {		/* |x|<22 */
		/*
			å½“|x|éå¸¸å°ï¼ˆ|x|< 2^-28ï¼‰æ—¶ï¼Œå‡½æ•°sinh(x)Â åº”è¯¥ä½¿ç”¨è¿‘ä¼¼å…¬å¼Â sinh(x)â‰ˆxÂ è¿›è¡Œè®¡ç®—ï¼Œä»¥æœ€å°åŒ–è¯¯å·®ã€‚
		*/
	    if (ix<0x3e300000) 		/* |x|<2**-28 */
			if(shuge+x>one) return x;/* sinh(tiny) = tiny with inexact */
		/*
			ä½¿ç”¨ç›´æ¥çš„æŒ‡æ•°å‡½æ•°è®¡ç®—Â sinh(x) = (e^x - e^-x) / 2
		*/
	    t = expm1(fabs(x));
	    if(ix<0x3ff00000) return h*(2.0*t-t*t/(t+one));
	    return h*(t+t/(t+one));
	}

    /* 
		å¯¹äºè¾ƒå¤§å€¼çš„|x|ï¼ˆ22â‰¤|x|<log(maxdouble)ï¼‰ï¼Œå‡½æ•°sinh(x)Â åº”è¯¥ä½¿ç”¨è¿‘ä¼¼å…¬å¼sinh(x) â‰ˆ e^x / 2è¿›è¡Œè®¡ç®—ï¼Œä»¥é¿å…æº¢å‡ºå¹¶ä¿æŒå‡†ç¡®æ€§
	 */
	if (ix < 0x40862E42)  return h*__ieee754_exp(fabs(x));

    /* 
		å¯¹äº|x|æ¥è¿‘æœºå™¨æµ®ç‚¹æ•°è¡¨ç¤ºæé™å€¼ï¼ˆlog(maxdouble)â‰¤|x|â‰¤overflowthresoldï¼‰çš„æƒ…å†µï¼Œå‡½æ•°sinh(x)Â åº”è¯¥ä½¿ç”¨è°ƒæ•´åçš„æŒ‡æ•°è®¡ç®—å…¬å¼ä»¥é¿å…æº¢å‡ºå¹¶ä¿æŒæ•°å€¼ç¨³å®šæ€§ï¼š
		sinh(x) = (e ^ (x / 2) / 2) * e ^ (x / 2)
	*/
	if (ix<=0x408633CE)
	    return h*2.0*__ldexp_exp(fabs(x), -1);

    /* 
		è¾“å…¥èŒƒå›´ä¸º|x|>overflowthresoldæ—¶ï¼Œåœ¨è¿™ä¸ªèŒƒå›´å†…ï¼Œxéå¸¸å¤§ï¼Œsinh(x)çš„ç»“æœä¼šéå¸¸å¤§ï¼Œæ¥è¿‘äºè®¡ç®—æœºèƒ½è¡¨ç¤ºçš„æœ€å¤§æ•°å€¼ã€‚è¿”å›ä¸€ä¸ªæå¤§çš„æ•°å€¼æ¥è¡¨ç¤ºæº¢å‡ºæƒ…å†µ,å³è¿”å›sinh(x) = x * 1.0e307
	*/
	return x*shuge;
}